@page "/assets"
@attribute [Authorize]
@inject ApiClient Api
@inject NavigationManager Navigation

<PageTitle>Assets - IAMS</PageTitle>

<div class="space-y-4 sm:space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white">Assets</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Manage your IT inventory</p>
        </div>
        <AuthorizeView Roles="Admin,Staff">
            <a href="/assets/new" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-all duration-200 shadow-lg shadow-primary-500/25 btn-press text-sm sm:text-base">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Asset
            </a>
        </AuthorizeView>
    </div>

    <!-- Filters -->
    <div class="flex flex-col gap-3">
        <!-- Search -->
        <div class="relative">
            <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text"
                   @bind="_search"
                   @bind:event="oninput"
                   @onkeyup="HandleSearch"
                   placeholder="Search by tag, manufacturer, model, serial..."
                   class="w-full pl-11 pr-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 transition-all duration-200 hover:border-slate-300 dark:hover:border-slate-500 focus:border-primary-500 text-sm" />
        </div>
        <!-- Filter Dropdowns -->
        <div class="flex flex-col sm:flex-row gap-3">
            <select @bind="_deviceType" @bind:after="LoadAssets" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white transition-all duration-200 text-sm">
                <option value="">All Device Types</option>
                @if (_deviceTypes is not null)
                {
                    @foreach (var dt in _deviceTypes)
                    {
                        <option value="@dt">@dt</option>
                    }
                }
            </select>
            <select @bind="_status" @bind:after="LoadAssets" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white transition-all duration-200 text-sm">
                <option value="">All Statuses</option>
                @if (_statuses is not null)
                {
                    @foreach (var stat in _statuses)
                    {
                        <option value="@stat">@stat</option>
                    }
                }
            </select>
        </div>
    </div>

    <!-- Results Summary & View Toggle -->
    @if (_assets is not null && !_loading)
    {
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="text-sm text-slate-500 dark:text-slate-400">
                Showing @_assets.Items.Count of @_assets.TotalCount assets
                @if (_hasFilters)
                {
                    <button @onclick="ClearFilters" class="ml-2 text-primary-600 dark:text-primary-400 hover:underline">
                        Clear filters
                    </button>
                }
            </div>

            <!-- View Toggle -->
            <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 rounded-xl p-1">
                <button @onclick="() => _viewMode = ViewMode.Cards"
                        class="@GetViewToggleClass(ViewMode.Cards) flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                    Cards
                </button>
                <button @onclick="() => _viewMode = ViewMode.Grid"
                        class="@GetViewToggleClass(ViewMode.Grid) flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                    Grid
                </button>
            </div>
        </div>
    }

    <!-- Assets Grid - Card-based mobile-first layout -->
    @if (_loading)
    {
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            @for (int i = 0; i < 6; i++)
            {
                <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-4 sm:p-5">
                    <div class="flex items-start gap-3 sm:gap-4">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl skeleton"></div>
                        <div class="flex-1 space-y-2">
                            <div class="h-5 w-2/3 rounded skeleton"></div>
                            <div class="h-4 w-1/2 rounded skeleton"></div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-2">
                        <div class="h-4 rounded skeleton"></div>
                        <div class="h-4 rounded skeleton"></div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between">
                        <div class="h-5 w-24 rounded skeleton"></div>
                        <div class="h-5 w-16 rounded skeleton"></div>
                    </div>
                </div>
            }
        </div>
    }
    else if (_assets?.Items.Any() == true)
    {
        @if (_viewMode == ViewMode.Cards)
        {
            <!-- Cards View -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                @foreach (var asset in _assets.Items)
                {
                    <div class="stagger-item">
                        <AssetCard Asset="asset" />
                    </div>
                }
            </div>
        }
        else
        {
            <!-- Grid/Table View -->
            <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-slate-50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700">
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Asset</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Type</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider hidden sm:table-cell">Serial</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider hidden md:table-cell">Assigned To</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider hidden lg:table-cell">Warranty</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-600 dark:text-slate-300 uppercase tracking-wider hidden xl:table-cell">Price</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 dark:divide-slate-700">
                            @foreach (var asset in _assets.Items)
                            {
                                <tr @onclick="() => NavigateToAsset(asset.Id)"
                                    class="hover:bg-slate-50 dark:hover:bg-slate-700/30 cursor-pointer transition-colors duration-150">
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg @GetDeviceTypeBg(asset.DeviceType) flex items-center justify-center shrink-0">
                                                @GetDeviceIcon(asset.DeviceType)
                                            </div>
                                            <div class="min-w-0">
                                                <div class="font-medium text-slate-900 dark:text-white truncate text-sm">@asset.DisplayName</div>
                                                <div class="text-xs text-slate-500 dark:text-slate-400 font-mono">@asset.AssetTag</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="text-sm text-slate-600 dark:text-slate-300">@asset.DeviceType</span>
                                    </td>
                                    <td class="px-4 py-3 hidden sm:table-cell">
                                        <span class="text-sm text-slate-500 dark:text-slate-400 font-mono">@(asset.SerialNumber ?? "-")</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <Badge Text="@asset.Status" Variant="@asset.Status" />
                                    </td>
                                    <td class="px-4 py-3 hidden md:table-cell">
                                        @if (!string.IsNullOrEmpty(asset.AssignedToUserName))
                                        {
                                            <div class="flex items-center gap-2">
                                                <div class="w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
                                                    <span class="text-primary-600 dark:text-primary-400 font-medium text-xs">@GetInitials(asset.AssignedToUserName)</span>
                                                </div>
                                                <span class="text-sm text-slate-600 dark:text-slate-300 truncate max-w-[120px]">@asset.AssignedToUserName</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-sm text-slate-400 dark:text-slate-500">Unassigned</span>
                                        }
                                    </td>
                                    <td class="px-4 py-3 hidden lg:table-cell">
                                        @if (asset.WarrantyStatus != WarrantyStatus.None)
                                        {
                                            <Badge Text="@GetWarrantyBadgeText(asset)" Variant="@GetWarrantyBadgeVariant(asset)" Pulse="@(asset.WarrantyStatus == WarrantyStatus.Expiring)" />
                                        }
                                        else
                                        {
                                            <span class="text-sm text-slate-400 dark:text-slate-500">-</span>
                                        }
                                    </td>
                                    <td class="px-4 py-3 text-right hidden xl:table-cell">
                                        @if (asset.PurchasePrice.HasValue)
                                        {
                                            <span class="text-sm text-slate-600 dark:text-slate-300">@FormatPrice(asset.PurchasePrice.Value, asset.Currency)</span>
                                        }
                                        else
                                        {
                                            <span class="text-sm text-slate-400 dark:text-slate-500">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <!-- Pagination -->
        @if (_assets.TotalPages > 1)
        {
            <div class="flex items-center justify-center gap-2 pt-4">
                <button @onclick="() => ChangePage(_page - 1)"
                        disabled="@(!_assets.HasPrevious)"
                        class="p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <span class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400">
                    Page @_page of @_assets.TotalPages
                </span>
                <button @onclick="() => ChangePage(_page + 1)"
                        disabled="@(!_assets.HasNext)"
                        class="p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        }
    }
    else
    {
        <Card>
            <EmptyState Title="No assets found" Description="@(_hasFilters ? "Try adjusting your filters." : "Add your first asset to get started.")">
                @if (!_hasFilters)
                {
                    <AuthorizeView Roles="Admin,Staff">
                        <a href="/assets/new" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-all duration-200">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Asset
                        </a>
                    </AuthorizeView>
                }
                else
                {
                    <button @onclick="ClearFilters" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-xl font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-all duration-200">
                        Clear Filters
                    </button>
                }
            </EmptyState>
        </Card>
    }
</div>

@code {
    private bool _loading = true;
    private PagedResponse<AssetDto>? _assets;
    private string[]? _deviceTypes;
    private string[]? _statuses;
    private string _search = "";
    private string _deviceType = "";
    private string _status = "";
    private int _page = 1;
    private System.Timers.Timer? _searchTimer;
    private ViewMode _viewMode = ViewMode.Cards;

    private enum ViewMode { Cards, Grid }

    private bool _hasFilters => !string.IsNullOrEmpty(_search) || !string.IsNullOrEmpty(_deviceType) || !string.IsNullOrEmpty(_status);

    private string GetViewToggleClass(ViewMode mode) => _viewMode == mode
        ? "bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm"
        : "text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-300";

    protected override async Task OnInitializedAsync()
    {
        _deviceTypes = await Api.GetDeviceTypesAsync();
        _statuses = await Api.GetStatusesAsync();
        await LoadAssets();
    }

    private async Task LoadAssets()
    {
        _loading = true;
        StateHasChanged();

        _assets = await Api.GetAssetsAsync(_search, _deviceType, _status, null, _page);
        _loading = false;
    }

    private void HandleSearch(KeyboardEventArgs e)
    {
        _searchTimer?.Stop();
        _searchTimer?.Dispose();
        _searchTimer = new System.Timers.Timer(300);
        _searchTimer.Elapsed += async (s, ev) =>
        {
            _searchTimer?.Stop();
            _page = 1;
            await InvokeAsync(async () =>
            {
                await LoadAssets();
                StateHasChanged();
            });
        };
        _searchTimer.Start();
    }

    private async Task ChangePage(int newPage)
    {
        _page = newPage;
        await LoadAssets();
    }

    private async Task ClearFilters()
    {
        _search = "";
        _deviceType = "";
        _status = "";
        _page = 1;
        await LoadAssets();
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
    }

    private void NavigateToAsset(int id)
    {
        Navigation.NavigateTo($"/assets/{id}");
    }

    private string GetDeviceTypeBg(string deviceType) => deviceType switch
    {
        "Laptop" or "Desktop" => "bg-blue-100 dark:bg-blue-900/30",
        "Monitor" => "bg-purple-100 dark:bg-purple-900/30",
        "Phone" or "Tablet" => "bg-green-100 dark:bg-green-900/30",
        "Printer" => "bg-orange-100 dark:bg-orange-900/30",
        "Network" or "Server" => "bg-red-100 dark:bg-red-900/30",
        _ => "bg-slate-100 dark:bg-slate-700"
    };

    private RenderFragment GetDeviceIcon(string deviceType) => deviceType switch
    {
        "Laptop" or "Desktop" => @<svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
        "Monitor" => @<svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
        "Phone" => @<svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
        "Tablet" => @<svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>,
        "Printer" => @<svg class="w-4 h-4 text-orange-600 dark:text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>,
        "Network" or "Server" => @<svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" /></svg>,
        _ => @<svg class="w-4 h-4 text-slate-600 dark:text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
    };

    private string FormatPrice(decimal price, string currency) => currency switch
    {
        "USD" => $"${price:N2}",
        "EUR" => $"\u20AC{price:N2}",
        "GBP" => $"\u00A3{price:N2}",
        "PHP" => $"\u20B1{price:N2}",
        "JPY" => $"\u00A5{price:N0}",
        _ => $"{currency} {price:N2}"
    };

    private string GetInitials(string name)
    {
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        return parts.Length > 0 ? parts[0][0].ToString().ToUpper() : "?";
    }

    private string GetWarrantyBadgeVariant(AssetDto asset) => asset.WarrantyStatus switch
    {
        WarrantyStatus.Active => "warranty-active",
        WarrantyStatus.Expiring => "warranty-expiring",
        WarrantyStatus.Expired => "warranty-expired",
        _ => "default"
    };

    private string GetWarrantyBadgeText(AssetDto asset)
    {
        var days = asset.WarrantyDaysRemaining ?? 0;
        return asset.WarrantyStatus switch
        {
            WarrantyStatus.Active => asset.WarrantyEndDate?.ToString("MMM yyyy") ?? "Active",
            WarrantyStatus.Expiring => days <= 30 ? $"{days}d left" : $"{days / 30}mo left",
            WarrantyStatus.Expired => "Expired",
            _ => ""
        };
    }
}
