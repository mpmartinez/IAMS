@page "/assets"
@attribute [Authorize]
@inject ApiClient Api
@inject NavigationManager Navigation

<PageTitle>Assets - IAMS</PageTitle>

<div class="space-y-4 sm:space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white">Assets</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Manage your IT inventory</p>
        </div>
        <AuthorizeView Roles="Admin,Staff">
            <a href="/assets/new" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-all duration-200 shadow-lg shadow-primary-500/25 btn-press text-sm sm:text-base">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Asset
            </a>
        </AuthorizeView>
    </div>

    <!-- Filters -->
    <div class="flex flex-col gap-3">
        <!-- Search -->
        <div class="relative">
            <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text"
                   @bind="_search"
                   @bind:event="oninput"
                   @onkeyup="HandleSearch"
                   placeholder="Search by tag, manufacturer, model, serial..."
                   class="w-full pl-11 pr-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 transition-all duration-200 hover:border-slate-300 dark:hover:border-slate-500 focus:border-primary-500 text-sm" />
        </div>
        <!-- Filter Dropdowns -->
        <div class="flex flex-col sm:flex-row gap-3">
            <select @bind="_deviceType" @bind:after="LoadAssets" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white transition-all duration-200 text-sm">
                <option value="">All Device Types</option>
                @if (_deviceTypes is not null)
                {
                    @foreach (var dt in _deviceTypes)
                    {
                        <option value="@dt">@dt</option>
                    }
                }
            </select>
            <select @bind="_status" @bind:after="LoadAssets" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-white transition-all duration-200 text-sm">
                <option value="">All Statuses</option>
                @if (_statuses is not null)
                {
                    @foreach (var stat in _statuses)
                    {
                        <option value="@stat">@stat</option>
                    }
                }
            </select>
        </div>
    </div>

    <!-- Results Summary -->
    @if (_assets is not null && !_loading)
    {
        <div class="text-sm text-slate-500 dark:text-slate-400">
            Showing @_assets.Items.Count of @_assets.TotalCount assets
            @if (_hasFilters)
            {
                <button @onclick="ClearFilters" class="ml-2 text-primary-600 dark:text-primary-400 hover:underline">
                    Clear filters
                </button>
            }
        </div>
    }

    <!-- Assets Grid - Card-based mobile-first layout -->
    @if (_loading)
    {
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            @for (int i = 0; i < 6; i++)
            {
                <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-4 sm:p-5">
                    <div class="flex items-start gap-3 sm:gap-4">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl skeleton"></div>
                        <div class="flex-1 space-y-2">
                            <div class="h-5 w-2/3 rounded skeleton"></div>
                            <div class="h-4 w-1/2 rounded skeleton"></div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-2">
                        <div class="h-4 rounded skeleton"></div>
                        <div class="h-4 rounded skeleton"></div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-100 dark:border-slate-700 flex justify-between">
                        <div class="h-5 w-24 rounded skeleton"></div>
                        <div class="h-5 w-16 rounded skeleton"></div>
                    </div>
                </div>
            }
        </div>
    }
    else if (_assets?.Items.Any() == true)
    {
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
            @foreach (var asset in _assets.Items)
            {
                <div class="stagger-item">
                    <AssetCard Asset="asset" />
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (_assets.TotalPages > 1)
        {
            <div class="flex items-center justify-center gap-2 pt-4">
                <button @onclick="() => ChangePage(_page - 1)"
                        disabled="@(!_assets.HasPrevious)"
                        class="p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <span class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400">
                    Page @_page of @_assets.TotalPages
                </span>
                <button @onclick="() => ChangePage(_page + 1)"
                        disabled="@(!_assets.HasNext)"
                        class="p-2 rounded-lg border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        }
    }
    else
    {
        <Card>
            <EmptyState Title="No assets found" Description="@(_hasFilters ? "Try adjusting your filters." : "Add your first asset to get started.")">
                @if (!_hasFilters)
                {
                    <AuthorizeView Roles="Admin,Staff">
                        <a href="/assets/new" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-all duration-200">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Asset
                        </a>
                    </AuthorizeView>
                }
                else
                {
                    <button @onclick="ClearFilters" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-xl font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-all duration-200">
                        Clear Filters
                    </button>
                }
            </EmptyState>
        </Card>
    }
</div>

@code {
    private bool _loading = true;
    private PagedResponse<AssetDto>? _assets;
    private string[]? _deviceTypes;
    private string[]? _statuses;
    private string _search = "";
    private string _deviceType = "";
    private string _status = "";
    private int _page = 1;
    private System.Timers.Timer? _searchTimer;

    private bool _hasFilters => !string.IsNullOrEmpty(_search) || !string.IsNullOrEmpty(_deviceType) || !string.IsNullOrEmpty(_status);

    protected override async Task OnInitializedAsync()
    {
        _deviceTypes = await Api.GetDeviceTypesAsync();
        _statuses = await Api.GetStatusesAsync();
        await LoadAssets();
    }

    private async Task LoadAssets()
    {
        _loading = true;
        StateHasChanged();

        _assets = await Api.GetAssetsAsync(_search, _deviceType, _status, null, _page);
        _loading = false;
    }

    private void HandleSearch(KeyboardEventArgs e)
    {
        _searchTimer?.Stop();
        _searchTimer?.Dispose();
        _searchTimer = new System.Timers.Timer(300);
        _searchTimer.Elapsed += async (s, ev) =>
        {
            _searchTimer?.Stop();
            _page = 1;
            await InvokeAsync(async () =>
            {
                await LoadAssets();
                StateHasChanged();
            });
        };
        _searchTimer.Start();
    }

    private async Task ChangePage(int newPage)
    {
        _page = newPage;
        await LoadAssets();
    }

    private async Task ClearFilters()
    {
        _search = "";
        _deviceType = "";
        _status = "";
        _page = 1;
        await LoadAssets();
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
    }
}
