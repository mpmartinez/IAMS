@page "/login"
@layout AuthLayout
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Login - IAMS</PageTitle>

<h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">Welcome back</h2>
<p class="text-slate-500 dark:text-slate-400 mb-8">Sign in to manage your assets</p>

<EditForm Model="@_model" OnValidSubmit="HandleLogin" class="space-y-5">
    <Input Label="Email" Type="email" @bind-Value="_model.Email" Placeholder="you@company.com" Error="@_emailError" />
    <Input Label="Password" Type="password" @bind-Value="_model.Password" Placeholder="Enter your password" Error="@_passwordError" />

    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="p-3 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 animate-slide-up">
            <p class="text-sm text-red-600 dark:text-red-400">@_error</p>
        </div>
    }

    <Button Type="submit" Loading="@_loading" Disabled="@_loading">
        @if (_loading)
        {
            <span>Signing in...</span>
        }
        else
        {
            <span>Sign in</span>
        }
    </Button>
</EditForm>

<div class="mt-6 text-center">
    <p class="text-sm text-slate-500 dark:text-slate-400">
        Don't have an account?
        <a href="/register" class="text-primary-600 hover:text-primary-700 dark:text-primary-400 font-medium transition-colors">
            Sign up
        </a>
    </p>
</div>

<div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
    <p class="text-xs text-slate-400 text-center mb-3">Demo credentials</p>
    <div class="grid grid-cols-3 gap-2">
        <button type="button" @onclick='() => FillCredentials("admin@company.com", "Admin123!")' class="px-3 py-2.5 text-xs bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all shadow-sm active:scale-95">
            <div class="font-semibold">Admin</div>
            <div class="text-purple-200 text-[10px] mt-0.5">Full access</div>
        </button>
        <button type="button" @onclick='() => FillCredentials("staff@company.com", "Staff123!")' class="px-3 py-2.5 text-xs bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all shadow-sm active:scale-95">
            <div class="font-semibold">Staff</div>
            <div class="text-blue-200 text-[10px] mt-0.5">Manage assets</div>
        </button>
        <button type="button" @onclick='() => FillCredentials("auditor@company.com", "Auditor123!")' class="px-3 py-2.5 text-xs bg-gradient-to-r from-teal-500 to-teal-600 text-white rounded-lg hover:from-teal-600 hover:to-teal-700 transition-all shadow-sm active:scale-95">
            <div class="font-semibold">Auditor</div>
            <div class="text-teal-200 text-[10px] mt-0.5">View reports</div>
        </button>
    </div>
</div>

@code {
    private LoginModel _model = new();
    private bool _loading;
    private string? _error;
    private string? _emailError;
    private string? _passwordError;

    private void FillCredentials(string email, string password)
    {
        _model.Email = email;
        _model.Password = password;
        StateHasChanged();
    }

    private async Task HandleLogin()
    {
        _error = null;
        _emailError = null;
        _passwordError = null;

        if (string.IsNullOrWhiteSpace(_model.Email))
        {
            _emailError = "Email is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(_model.Password))
        {
            _passwordError = "Password is required";
            return;
        }

        _loading = true;

        var (success, error) = await AuthService.LoginAsync(_model.Email, _model.Password);

        if (success)
        {
            Navigation.NavigateTo("/", forceLoad: true);
        }
        else
        {
            _error = error ?? "Invalid email or password";
            _loading = false;
        }
    }

    private class LoginModel
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
    }
}
